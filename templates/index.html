<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chatbot</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.1/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; }
        .container { display: flex; }
        .chat-history { max-width: 200px; border-right: 2px solid #ddd; padding: 10px; }
        .chat-container { flex-grow: 1; padding: 10px; }
        .message { margin: 5px 0; padding: 10px; border-radius: 5px; }
        .user { background-color: #f0f0f0; }
        .bot { background-color: #d1e7dd; }
    </style>
</head>
<body>
    <h2>Chatbot</h2>
    <div class="container">
        <div class="chat-history">
            <h5>Past Chats</h5>
            {% for chat in chats %}
            <div><a href="/view_chat/{{ loop.index0 }}">Chat #{{ loop.index }}</a></div>
            {% endfor %}
    
            <a href="/new_chat" class="btn btn-primary mt-2">New Chat</a>
        </div>
        <div class="chat-container">
            {% for entry in current_chat %}
                <div class="message user"><b>User:</b> {{ entry.user_input }}</div>
                <div class="message bot">
                    <b>{{entry.model}}:</b> {{ entry.response }}
                    {% if entry.audio_output_file %}
                    <audio controls>
                        <source src="/{{ entry.audio_output_file }}" type="audio/wav">
                        Your browser does not support the audio element.
                    </audio>
                    {% endif %}
                </div>
            {% endfor %}
            <form id="chatForm" action="/" method="POST" enctype="multipart/form-data" class="mt-3">
                <div class="input-group mb-3">
                    <button type="button" class="btn input-group-text" id="start-recording">
                        <i class="bi bi-mic"></i>
                    </button>
                    <input type="text" class="form-control" name="user_input" placeholder="Type a message..." required>
                    <input type="file" accept="audio/*" capture style="display: none" name="audio_file" id="audioInput">
                    <select class="form-select" name="model" required>
                        <option value="microsoft/DialoGPT-medium">microsoft/DialoGPT-medium</option>
                        <option value="gpt2-medium">gpt2-medium</option>
                        <option value="EleutherAI/gpt-neo-1.3B">EleutherAI/gpt-neo-1.3B</option>
                    </select>
                    <button class="btn btn-outline-secondary" type="submit">ASK</button>
                </div>
            </form>
        </div>
        
    </div>
    
    <script>
    let mediaRecorder;
    let audioChunks = [];
    
    document.getElementById("start-recording").onclick = function() {
    if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        document.getElementById("start-recording").textContent = "Start Recording";
    } else {
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();
                audioChunks = [];
    
                mediaRecorder.ondataavailable = function(event) {
                    audioChunks.push(event.data);
                };
    
                mediaRecorder.onstop = function() {
                    const audioBlob = new Blob(audioChunks, {type: 'audio/wav'});
                    const audioInput = document.getElementById("audioInput");
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(new File([audioBlob], "recording.wav", {type: 'audio/wav'}));
                    audioInput.files = dataTransfer.files;
                    document.getElementById("chatForm").submit();
                };
    
                document.getElementById("start-recording").textContent = "Stop Recording";
            })
            .catch(error => console.error(error));
    }
};

    </script>
    </body>
    
</html>
